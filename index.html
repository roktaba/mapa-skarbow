<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Mapa Skarb√≥w</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root { --bg:#f7f7fb; --fg:#1f2937; --brand:#ff7a00; --accent:#00a884; --muted:#94a3b8; --card:#ffffff; --danger:#e11d48; --x-size:22px; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    #map{width:100%;height:100%}

    .controls{position:absolute;top:5.5rem;left:.75rem;z-index:900;display:grid;gap:.4rem}
    .btn{appearance:none;border:0;background:var(--card);color:#111;padding:.55rem 0.9rem;border-radius:.8rem;box-shadow:0 4px 16px rgba(0,0,0,.12);font-weight:700;font-size:.95rem}
    .btn.brand{background:var(--brand);color:#fff;border:3px solid #fff;box-shadow:0 4px 12px rgba(0,0,0,.4)}
    .btn.accent{background:var(--accent);color:#fff}

    .x-marker{background:transparent;display:grid;place-items:center}
    .x-marker> b{font-size:var(--x-size);color:var(--danger);-webkit-text-stroke:2px #fff;text-shadow:0 1px 0 #fff,0 0 6px rgba(0,0,0,.35);line-height:1}
    .x-marker.hidden{display:none}
    .x-marker.found{opacity:.35;filter:grayscale(1)}

    .status{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(env(safe-area-inset-bottom) + 4.6rem);z-index:1000;background:var(--card);padding:.7rem .95rem;border-radius:.9rem;box-shadow:0 6px 18px rgba(0,0,0,.15);min-width:260px;text-align:center}
    .status .counter{font-weight:800}
    .status .text{color:var(--muted);font-weight:700;margin-top:.25rem}

    .pinbar{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(env(safe-area-inset-bottom) + 1rem);z-index:1000}
    .toast{position:fixed;left:50%;bottom:9.8rem;transform:translateX(-50%);background:#111827;color:#fff;padding:.7rem .9rem;border-radius:.8rem;box-shadow:0 8px 20px rgba(0,0,0,.3);font-weight:700;opacity:0;pointer-events:none;transition:opacity .25s ease}
    .toast.show{opacity:1}
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="controls">
    <button class="btn brand" id="hintBtn">üó∫Ô∏è Podpowied≈∫</button>
    <button class="btn" id="resetBtn">üîÅ Reset</button>
    <button class="btn accent" id="newGameBtn">üéØ Nowa gra</button>
    <button class="btn" id="startBtn">‚ñ∂Ô∏è Start gry</button>
  </div>

  <div class="status">
    <div><span class="counter" id="statusCounter">0/0</span></div>
    <div class="text" id="statusText">Kliknij ‚ÄûNowa gra‚Äù, aby dodaƒá skarby.</div>
  </div>

  <div class="pinbar">
    <button class="btn" id="enterPinBtn" style="padding:1rem 1.25rem;font-size:1rem;border:3px solid #fff;box-shadow:0 6px 18px rgba(0,0,0,.35);">üî¢ Wpisz has≈Ço</button>
  </div>

  <div class="toast" id="toast">Znaleziono skarb! üèÜ</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const MAP_IMAGE_URL='nowyplan.jpg';

    // Skarby: {id,posPct:[x%,y%],hint,code}
    let TREASURES=[];
    const state={imageSize:null,editing:false,found:new Set()};

    const toast=(m)=>{const el=document.getElementById('toast');el.textContent=m;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),1400);};
    const setStatus=(text)=>{ if(text!==undefined) document.getElementById('statusText').textContent=text; };
    const updateCounter=()=>{ const total=TREASURES.length; const found=[...state.found].filter(id=>TREASURES.some(t=>t.id===id)).length; document.getElementById('statusCounter').textContent=`${found}/${total}`; };
    const updateStatus=(text)=>{ updateCounter(); setStatus(text); };

    const map=L.map('map',{crs:L.CRS.Simple,zoomControl:false,minZoom:-2,maxZoom:2});
    let markers=new Map();

    function getMaxZoomForImage(){return 2;}
    function pxToLatLng(x,y){return map.unproject([x,y],getMaxZoomForImage());}
    function latLngToPx(latlng){return map.project(latlng,getMaxZoomForImage());}
    function pctToPx([xp,yp]){const w=state.imageSize.w,h=state.imageSize.h;return [xp/100*w,yp/100*h];}

    function addMarker(t,visible){
      const iconHtml=`<div class="x-marker ${visible?'':'hidden'} ${state.found.has(t.id)?'found':''}"><b>‚úñ</b></div>`;
      const icon=L.divIcon({html:iconHtml,className:'',iconSize:[36,36],iconAnchor:[18,18]});
      const [x,y]=pctToPx(t.posPct); const ll=pxToLatLng(x,y);
      const m=L.marker(ll,{icon}).addTo(map);
      // Klik w X nadal dzia≈Ça (opcjonalnie), ale nie jest wymagany
      m.on('click',()=>trySolveById(t.id));
      markers.set(t.id,m);
    }

    function refreshMarkers(){
      markers.forEach(m=>map.removeLayer(m)); markers.clear();
      TREASURES.forEach((t,i)=>addMarker(t,i===0));
      updateCounter();
    }

    function showOnlyFirst(){
      TREASURES.forEach((t,i)=>{
        const el=markers.get(t.id)?.getElement()?.querySelector('.x-marker');
        if(!el) return; if(i===0) el.classList.remove('hidden'); else el.classList.add('hidden');
      });
      updateCounter();
    }

    function currentVisibleIndex(){
      for(let i=0;i<TREASURES.length;i++){
        const id=TREASURES[i].id;
        if(state.found.has(id)) continue;
        const el=markers.get(id)?.getElement()?.querySelector('.x-marker');
        if(el && !el.classList.contains('hidden')) return i;
      }
      return -1;
    }

    function revealNextById(id){
      const idx=TREASURES.findIndex(x=>x.id===id);
      if(idx+1<TREASURES.length){
        const nm=markers.get(TREASURES[idx+1].id);
        nm?.getElement()?.querySelector('.x-marker')?.classList.remove('hidden');
        updateStatus('Brawo! Teraz wpisz has≈Ço do nastƒôpnego X.');
      } else {
        updateStatus('üéâ Wygrana! Wszystkie skarby zdobyte.');
        toast('Wszystkie skarby zdobyte! üéâ');
      }
    }

    function trySolveById(id){
      const t=TREASURES.find(x=>x.id===id); if(!t) return;
      const el=markers.get(id)?.getElement()?.querySelector('.x-marker');
      if(!el || el.classList.contains('hidden')){ toast('Najpierw odblokuj poprzedni skarb lub wci≈õnij ‚ñ∂Ô∏è Start gry.'); return; }
      const v=prompt(`Wpisz 4-cyfrowe has≈Ço:\n${t.hint||t.id}`);
      if(v===null) return; const s=String(v).trim();
      if(!/^\d{4}$/.test(s)){ toast('Has≈Ço musi mieƒá dok≈Çadnie 4 cyfry.'); return; }
      if(s===t.code){ state.found.add(id); el.classList.add('found'); updateStatus('Skarb zdobyty! üèÜ'); revealNextById(id); } else { toast('B≈Çƒôdne has≈Ço ‚ùå'); }
    }

    // Dodawanie X-√≥w z walidacjƒÖ PIN (4 cyfry)
    map.on('click',e=>{
      if(!state.editing || !state.imageSize) return;
      const px=latLngToPx(e.latlng);
      const id='X'+(TREASURES.length+1);
      const posPct=[ Math.round((px.x/state.imageSize.w)*100), Math.round((px.y/state.imageSize.h)*100) ];
      let hint=prompt('Nazwa (wskaz√≥wka) dla skarbu:');
      if(hint===null) return; hint=hint.trim(); if(!hint){ toast('Wpisz nazwƒô/wskaz√≥wkƒô.'); return; }
      let code=null; while(true){ const inp=prompt('Ustal 4-cyfrowe has≈Ço dla skarbu:'); if(inp===null){ code=null; break; } const s=String(inp).trim(); if(/^\d{4}$/.test(s)){ code=s; break; } toast('Has≈Ço musi mieƒá dok≈Çadnie 4 cyfry.'); }
      if(code===null) return;
      const t={id,posPct,hint,code}; TREASURES.push(t); addMarker(t, TREASURES.length===1); updateCounter();
      const more=confirm('Dodaƒá kolejny X?'); if(!more){ state.editing=false; updateStatus('Gotowe. Naci≈õnij ‚ñ∂Ô∏è Start gry.'); }
    });

    // Przyciski
    document.getElementById('hintBtn').addEventListener('click',()=>{
      const i=currentVisibleIndex();
      if(i===-1){ toast(TREASURES.length?'Odblokuj poprzedni skarb.':'Brak punkt√≥w ‚Äî u≈ºyj ‚ÄûüéØ Nowa gra‚Äù.'); return; }
      updateStatus('Wskaz√≥wka: '+(TREASURES[i].hint||'Rozejrzyj siƒô uwa≈ºnie...'));
    });

    document.getElementById('enterPinBtn').addEventListener('click',()=>{
      const i=currentVisibleIndex();
      if(i===-1){ toast(TREASURES.length?'Najpierw odblokuj poprzedni skarb.':'Brak punkt√≥w ‚Äî u≈ºyj ‚ÄûüéØ Nowa gra‚Äù.'); return; }
      trySolveById(TREASURES[i].id);
      updateCounter();
    });

    document.getElementById('resetBtn').addEventListener('click',()=>{
      state.found.clear();
      showOnlyFirst();
      updateStatus('Postƒôp zresetowany. Wci≈õnij ‚ñ∂Ô∏è Start gry.');
    });

    document.getElementById('newGameBtn').addEventListener('click',()=>{
      if(!confirm('Czy na pewno chcesz rozpoczƒÖƒá nowƒÖ grƒô? Wszystkie skarby i postƒôp zostanƒÖ utracone.')) return;
      TREASURES=[]; state.found.clear(); refreshMarkers(); state.editing=true;
      updateStatus('Instrukcja: stuknij w mapƒô, aby dodaƒá X (nazwa + PIN 4 cyfry). Dodaj minimum jeden X, potem ‚Äû‚ñ∂Ô∏è Start gry‚Äù.');
    });

    document.getElementById('startBtn').addEventListener('click',()=>{
      if(TREASURES.length===0){ toast('Najpierw dodaj przynajmniej jeden X.'); return; }
      state.editing=false; showOnlyFirst();
      const i=currentVisibleIndex();
      const msg=i>-1?`Start! Wpisz has≈Ço do pierwszego X. Wskaz√≥wka: ${TREASURES[i].hint}`:'Start!';
      updateStatus(msg);
    });

    // Init
    (function init(){
      const img=new Image();
      img.onload=()=>{
        state.imageSize={w:img.naturalWidth,h:img.naturalHeight};
        const w=state.imageSize.w,h=state.imageSize.h;
        const sw=map.unproject([0,h],getMaxZoomForImage());
        const ne=map.unproject([w,0],getMaxZoomForImage());
        const bounds=new L.LatLngBounds(sw,ne);
        L.imageOverlay(MAP_IMAGE_URL,bounds).addTo(map);
        map.fitBounds(bounds); map.setMaxBounds(bounds.pad(0.2));
        updateStatus('Kliknij ‚ÄûNowa gra‚Äù, aby dodaƒá skarby.');
      };
      img.src=MAP_IMAGE_URL;
    })();
  </script>
</body>
</html>
