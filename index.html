<!doctype html>

<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Mapa Skarbów</title>
  <link rel="preconnect" href="https://unpkg.com">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root {
      --bg: #f7f7fb;
      --fg: #1f2937;
      --brand: #ff7a00;
      --accent: #00a884;
      --muted: #94a3b8;
      --card: #ffffff;
      --danger: #e11d48;
    }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--fg); font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .app { display: grid; grid-template-rows: auto 1fr auto; height: 100%; }
    header { display:flex; align-items:center; gap:.6rem; padding: .8rem 1rem; background: var(--card); box-shadow: 0 2px 10px rgba(0,0,0,.06); position: sticky; top: 0; z-index: 1000; }
    header h1 { font-size: 1.1rem; margin: 0; }
    header .badge { background: var(--brand); color: #fff; padding: .2rem .5rem; border-radius: 999px; font-weight: 700; font-size: .8rem; }#map { width: 100%; height: 100%; }
.controls { position: absolute; top: .75rem; left: .75rem; z-index: 900; display: grid; gap:.4rem; }
.btn { appearance: none; border: 0; background: var(--card); color: var(--fg); padding: .55rem .7rem; border-radius: .8rem; box-shadow: 0 4px 16px rgba(0,0,0,.12); font-weight: 700; font-size: .9rem; }
.btn:active { transform: translateY(1px); }
.btn.brand { background: var(--brand); color: #fff; }
.btn.accent { background: var(--accent); color: #fff; }

.panel { background: var(--card); padding: .8rem; border-top-left-radius: 1rem; border-top-right-radius: 1rem; box-shadow: 0 -8px 24px rgba(0,0,0,.08); }
.row { display: flex; align-items: center; justify-content: space-between; gap:.5rem; }
.progress { width: 100%; height: 10px; background: #e5e7eb; border-radius: 999px; overflow: hidden; }
.progress > i { display:block; height: 100%; width: 0%; background: linear-gradient(90deg, var(--brand), var(--accent)); transition: width .3s ease; }

.toast { position: fixed; left: 50%; bottom: 6rem; transform: translateX(-50%); background: #111827; color: #fff; padding: .7rem .9rem; border-radius: .8rem; box-shadow: 0 8px 20px rgba(0,0,0,.3); font-weight: 700; opacity: 0; pointer-events: none; transition: opacity .25s ease; }
.toast.show { opacity: 1; }

.leaflet-container { background: #dfe7ee; }

/* Marker X */
.x-marker { background: #fff; border-radius: 12px; border: 2px solid #11182722; padding: .05rem .3rem; line-height: 1; box-shadow: 0 2px 8px rgba(0,0,0,.18); display: grid; place-items: center; }
.x-marker > b { font-size: 28px; color: var(--danger); text-shadow: 0 1px 0 #fff, 0 2px 6px rgba(0,0,0,.25); }
.x-marker.found { opacity: .25; filter: grayscale(1); }

/* Duże przyciski dla dzieci */
.big { font-size: 1rem; padding: .8rem 1rem; }

@media (display-mode: standalone) {
  header { display:none; }
  .panel { padding-bottom: calc(env(safe-area-inset-bottom) + 1rem); }
}

  </style>
</head>
<body>
  <div class="app">
    <header>
      <span class="badge">🎒</span>
      <h1>Mapa Skarbów</h1>
    </header>
    <div id="map"></div><div class="controls">
  <button class="btn brand big" id="hintBtn">🗺️ Podpowiedź</button>
  <button class="btn big" id="resetBtn">🔁 Reset</button>
  <button class="btn big" id="addBtn" title="Tryb edycji: dodawaj nowe skarby">➕ Dodaj punkt</button>
  <button class="btn big" id="exportBtn" title="Eksportuj punkty jako JSON">📤 Eksport</button>
</div>

<div class="panel">
  <div class="row" style="margin-bottom:.6rem">
    <strong>Postęp</strong>
    <span id="counter">0/0</span>
  </div>
  <div class="progress"><i id="bar"></i></div>
  <div id="clue" style="margin-top:.6rem; color: var(--muted); font-weight: 600;">Dotknij mapy, by zbliżyć. Szukaj X! 🧭</div>
</div>

  </div>  <div class="toast" id="toast">Znaleziono skarb! 🏆</div>  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>  <script>
    // === USTAWIENIA ===
    // Ze względów na bezpieczeństwo i instalację PWA używamy lokalnego pliku z mapą.
    // 1) Pobierz obraz z: http://osrodek.ibwpan.gda.pl/files/9112/9803/3356/nowyplan.jpg
    // 2) Zapisz go obok tego pliku jako: nowyplan.jpg
    // Jeśli bardzo chcesz użyć zdalnego URL, podaj go tu, ale pamiętaj o HTTPS (inaczej przeglądarka zablokuje):
    const MAP_IMAGE_URL = 'nowyplan.jpg';

    // Promień trafienia w % krótszego boku obrazu (łatwiejsza skala dla różnych rozdzielczości)
    const CATCH_RADIUS_PCT = 3.5; // dla 7-latka: dość wybaczające (ok. 3–5% polecam)

    // Lista skarbów: pozycje w PROCENTACH 0–100 względem szerokości/wysokości obrazu
    // posPct: [x%, y%]
    let TREASURES = [
      { id: 'X1',  posPct: [12, 18], title: 'Skarb 1', hint: 'Tam, gdzie zaczyna się plażowa ścieżka.' },
      { id: 'X2',  posPct: [28, 35], title: 'Skarb 2', hint: 'Przy ławce w cieniu drzew.' },
      { id: 'X3',  posPct: [45, 22], title: 'Skarb 3', hint: 'Blisko recepcji i mapy ośrodka.' },
      { id: 'X4',  posPct: [65, 18], title: 'Skarb 4', hint: 'Spójrz w stronę molo lub pomostu.' },
      { id: 'X5',  posPct: [80, 30], title: 'Skarb 5', hint: 'Między dwiema ścieżkami jak rozgałęzienie.' },
      { id: 'X6',  posPct: [15, 60], title: 'Skarb 6', hint: 'Niedaleko placu zabaw (huśtawki!).' },
      { id: 'X7',  posPct: [35, 55], title: 'Skarb 7', hint: 'Przy krzakach, które szumią jak morze.' },
      { id: 'X8',  posPct: [55, 65], title: 'Skarb 8', hint: 'Obok szerokiej polany do biegania.' },
      { id: 'X9',  posPct: [75, 75], title: 'Skarb 9', hint: 'Za zakrętem, gdzie ścieżka robi „S”.' },
      { id: 'X10', posPct: [50, 85], title: 'Skarb 10', hint: 'Prawie na końcu drogi — jeszcze kawałek!' },
    ];

    // === KONIEC USTAWIEŃ ===

    const state = {
      imageSize: null, // {w,h}
      editing: false,
      found: new Set(JSON.parse(localStorage.getItem('foundTreasures') || '[]')),
    };

    const toast = (msg) => {
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 1400);
    };

    // Inicjalizacja mapy z niestandardową projekcją obrazka
    const map = L.map('map', {
      crs: L.CRS.Simple,
      zoomControl: false,
      minZoom: -2,
      maxZoom: 2,
      inertia: true,
    });

    let imageOverlay;
    let markers = new Map();

    function getMaxZoomForImage() { return 2; }

    function pctToPx(posPct) {
      const w = state.imageSize.w, h = state.imageSize.h;
      return [ (posPct[0] / 100) * w, (posPct[1] / 100) * h ];
    }

    function pxToLatLng(x, y) { return map.unproject([x, y], getMaxZoomForImage()); }
    function latLngToPx(latlng) { return map.project(latlng, getMaxZoomForImage()); }

    function catchRadiusPx() {
      const m = Math.min(state.imageSize.w, state.imageSize.h);
      return (CATCH_RADIUS_PCT / 100) * m;
    }

    function updateProgressUI() {
      const total = TREASURES.length;
      const foundCount = state.found.size;
      document.getElementById('counter').textContent = `${foundCount}/${total}`;
      const pct = total ? Math.round((foundCount/total)*100) : 0;
      document.getElementById('bar').style.width = pct + '%';
    }

    function saveFound() { localStorage.setItem('foundTreasures', JSON.stringify([...state.found])); }
    function setClue(text) { document.getElementById('clue').textContent = text; }

    function addMarker(t) {
      const iconHtml = `<div class="x-marker ${state.found.has(t.id) ? 'found' : ''}"><b>✖</b></div>`;
      const icon = L.divIcon({ html: iconHtml, className: '', iconSize: [32, 32], iconAnchor: [16, 16] });
      const [x, y] = t.posPct ? pctToPx(t.posPct) : t.pos; // kompatybilność
      const ll = pxToLatLng(x, y);
      const m = L.marker(ll, { icon }).addTo(map);
      m.on('click', () => onChestTap(t, m));
      markers.set(t.id, m);
    }

    function refreshMarkers() {
      markers.forEach(m => map.removeLayer(m));
      markers.clear();
      TREASURES.forEach(addMarker);
      updateProgressUI();
    }

    let lastTapPx = { x: 0, y: 0 };

    function onChestTap(t, marker) {
      if (!state.imageSize) return;
      const center = marker.getLatLng();
      const centerPx = latLngToPx(center);
      const dist = Math.hypot(centerPx.x - lastTapPx.x, centerPx.y - lastTapPx.y);
      if (dist <= catchRadiusPx()) {
        if (!state.found.has(t.id)) {
          state.found.add(t.id);
          saveFound();
          toast('Znaleziono skarb! 🏆');
          const el = marker.getElement();
          if (el) el.querySelector('.x-marker')?.classList.add('found');
          updateProgressUI();
          if (state.found.size === TREASURES.length) { setClue('Brawo! Odnalazłeś wszystkie skarby! 🎉'); }
        } else { toast('Ten skarb już masz ✔️'); }
      } else {
        toast('Jesteś blisko! Spróbuj podejść dokładniej 👣');
      }
    }

    // Wskazówka: pokaż losową podpowiedź do skarbu nieodnalezionego
    function showHint() {
      const remaining = TREASURES.filter(t => !state.found.has(t.id));
      if (!remaining.length) { setClue('Wszystko znalezione! 🎉'); return; }
      const t = remaining[Math.floor(Math.random()*remaining.length)];
      setClue(`Wskazówka: ${t.hint || 'Rozejrzyj się uważnie...'}`);
      const [x, y] = t.posPct ? pctToPx(t.posPct) : t.pos;
      map.setView(pxToLatLng(x, y), 1, { animate: true });
    }

    // Tryb edycji — dodawanie punktów dotknięciem (zapis w %)
    function toggleEdit() {
      state.editing = !state.editing;
      document.getElementById('addBtn').classList.toggle('accent', state.editing);
      setClue(state.editing ? 'Tryb edycji: stuknij na mapie, aby dodać X.' : 'Tryb edycji wyłączony.');
    }

    function exportJSON() {
      const json = JSON.stringify(TREASURES, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'skarbypunkty.json'; a.click();
      URL.revokeObjectURL(url);
    }

    function resetProgress() {
      state.found.clear();
      saveFound();
      refreshMarkers();
      setClue('Postęp wyzerowany. Powodzenia!');
    }

    map.on('click', (e) => {
      const px = latLngToPx(e.latlng);
      lastTapPx = { x: px.x, y: px.y };
      if (state.editing && state.imageSize) {
        const id = 'X' + (TREASURES.length + 1);
        const posPct = [ Math.round((px.x/state.imageSize.w)*100), Math.round((px.y/state.imageSize.h)*100) ];
        const newTreasure = { id, posPct, title: 'Nowy punkt', hint: 'Dodaj opis' };
        TREASURES.push(newTreasure);
        addMarker(newTreasure);
        updateProgressUI();
        setClue(`Dodano X ${id} (${posPct[0]}%, ${posPct[1]}%)`);
      }
    });

    // Przyciski UI
    document.getElementById('hintBtn').addEventListener('click', showHint);
    document.getElementById('resetBtn').addEventListener('click', resetProgress);
    document.getElementById('addBtn').addEventListener('click', toggleEdit);
    document.getElementById('exportBtn').addEventListener('click', exportJSON);

    // Załaduj obraz i skonfiguruj mapę
    (async function init() {
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = () => {
        state.imageSize = { w: img.naturalWidth, h: img.naturalHeight };
        const w = state.imageSize.w; const h = state.imageSize.h;
        const southWest = map.unproject([0, h], getMaxZoomForImage());
        const northEast = map.unproject([w, 0], getMaxZoomForImage());
        const bounds = new L.LatLngBounds(southWest, northEast);
        imageOverlay = L.imageOverlay(MAP_IMAGE_URL, bounds).addTo(map);
        map.fitBounds(bounds);
        map.setMaxBounds(bounds.pad(0.2));
        refreshMarkers();
      };
      img.onerror = () => { setClue('Nie udało się wczytać obrazu mapy. Upewnij się, że plik nowyplan.jpg leży obok index.html.'); };
      img.src = MAP_IMAGE_URL;

      // PWA: dynamiczny manifest z ikonami rysowanymi w locie
      const makeIcon = (size) => {
        const c = document.createElement('canvas');
        c.width = c.height = size; const ctx = c.getContext('2d');
        ctx.fillStyle = '#ff7a00'; ctx.fillRect(0,0,size,size);
        ctx.strokeStyle = '#fff'; ctx.lineWidth = Math.max(8, size*0.08);
        ctx.lineCap = 'round';
        ctx.beginPath();
        ctx.moveTo(size*0.25, size*0.25); ctx.lineTo(size*0.75, size*0.75);
        ctx.moveTo(size*0.75, size*0.25); ctx.lineTo(size*0.25, size*0.75);
        ctx.stroke();
        return c.toDataURL('image/png');
      };
      const manifest = {
        name: 'Mapa Skarbów',
        short_name: 'Skarby',
        start_url: '.',
        display: 'standalone',
        background_color: '#ffffff',
        theme_color: '#ff7a00',
        icons: [192, 512].map(s => ({ src: makeIcon(s), sizes: `${s}x${s}`, type: 'image/png' }))
      };
      const blob = new Blob([JSON.stringify(manifest)], {type: 'application/manifest+json'});
      const murl = URL.createObjectURL(blob);
      const link = document.createElement('link');
      link.rel = 'manifest'; link.href = murl; document.head.appendChild(link);

      // PWA: prosty Service Worker (wymagany przez Android Chrome do instalacji)
      if ('serviceWorker' in navigator) {
        const swCode = `const CACHE='skarb-cache-v1';
self.addEventListener('install',e=>{self.skipWaiting();e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./','./index.html','./nowyplan.jpg'])))});
self.addEventListener('activate',e=>clients.claim());
self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).then(res=>{const copy=res.clone(); caches.open(CACHE).then(c=>c.put(e.request,copy)).catch(()=>{}); return res;})).catch(()=>caches.match('./index.html')))});`;
        const swBlob = new Blob([swCode], {type: 'text/javascript'});
        const swUrl = URL.createObjectURL(swBlob);
        window.addEventListener('load', () => navigator.serviceWorker.register(swUrl));
      }
    })();
  </script></body>
</html>
