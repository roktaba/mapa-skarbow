<!doctype html>

<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Mapa Skarb√≥w</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root { --bg: #f7f7fb; --fg: #1f2937; --brand: #ff7a00; --accent: #00a884; --muted: #94a3b8; --card: #ffffff; --danger: #e11d48; --x-size: 22px; }
    html, body { height: 100%; margin: 0; background: var(--bg); font-family: system-ui; }
    #map { width: 100%; height: 100%; }
    .controls { position: absolute; top: 3.5rem; left: .75rem; z-index: 900; display: grid; gap:.4rem; }
    .btn { border: 0; background: var(--card); padding: .55rem .7rem; border-radius: .8rem; font-weight: 700; font-size: .9rem; }
    .btn.brand { background: var(--brand); color: #fff; border: 3px solid #fff; }
    .btn.accent { background: var(--accent); color: #fff; }
    .x-marker { background: transparent; display: grid; place-items: center; }
    .x-marker > b { font-size: var(--x-size); color: var(--danger); -webkit-text-stroke: 2px #fff; text-shadow: 0 1px 0 #fff, 0 0 6px rgba(0,0,0,.35); }
    .x-marker.hidden { display: none; }
    .x-marker.found { opacity: .35; filter: grayscale(1); }
    .toast { position: fixed; left: 50%; bottom: 6rem; transform: translateX(-50%); background: #111827; color: #fff; padding: .7rem .9rem; border-radius: .8rem; opacity: 0; transition: opacity .25s ease; }
    .toast.show { opacity: 1; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="controls">
    <button class="btn brand" id="hintBtn">üó∫Ô∏è Podpowied≈∫</button>
    <button class="btn" id="resetBtn">üîÅ Reset</button>
    <button class="btn accent" id="newGameBtn">üéØ Nowa gra</button>
  </div>
  <div class="toast" id="toast">Znaleziono skarb! üèÜ</div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const MAP_IMAGE_URL = 'nowyplan.jpg';
    let TREASURES = [];
    const state = { imageSize: null, editing: false, found: new Set() };
    const toast = (msg) => { const el = document.getElementById('toast'); el.textContent = msg; el.classList.add('show'); setTimeout(() => el.classList.remove('show'), 1400); };
    const map = L.map('map', { crs: L.CRS.Simple, zoomControl: false, minZoom: -2, maxZoom: 2 });
    let markers = new Map();
    function getMaxZoomForImage() { return 2; }
    function pxToLatLng(x, y) { return map.unproject([x, y], getMaxZoomForImage()); }
    function latLngToPx(latlng) { return map.project(latlng, getMaxZoomForImage()); }
    function pctToPx(posPct) { const w = state.imageSize.w, h = state.imageSize.h; return [ (posPct[0] / 100) * w, (posPct[1] / 100) * h ]; }
    function addMarker(t, index) {
      const visible = index === 0; // tylko pierwszy X widoczny
      const iconHtml = `<div class="x-marker ${!visible ? 'hidden' : ''} ${state.found.has(t.id) ? 'found' : ''}"><b>‚úñ</b></div>`;
      const icon = L.divIcon({ html: iconHtml, className: '', iconSize: [36, 36], iconAnchor: [18, 18] });
      const [x, y] = pctToPx(t.posPct);
      const ll = pxToLatLng(x, y);
      const m = L.marker(ll, { icon }).addTo(map);
      m.on('click', () => {
        if (!state.editing && !m.getElement().querySelector('.x-marker').classList.contains('hidden')) {
          const pwd = prompt('Podaj 4-cyfrowe has≈Ço:');
          if (pwd === t.code) {
            state.found.add(t.id);
            toast('Znaleziono skarb!');
            m.getElement().querySelector('.x-marker').classList.add('found');
            // odkryj nastƒôpny skarb
            const idx = TREASURES.findIndex(x => x.id === t.id);
            if (idx + 1 < TREASURES.length) {
              const nextMarker = markers.get(TREASURES[idx + 1].id);
              nextMarker.getElement().classList.remove('hidden');
            }
          } else {
            toast('B≈Çƒôdne has≈Ço ‚ùå');
          }
        }
      });
      markers.set(t.id, m);
    }
    function refreshMarkers() {
      markers.forEach(m => map.removeLayer(m));
      markers.clear();
      TREASURES.forEach((t, i) => addMarker(t, i));
    }
    map.on('click', (e) => {
      if (state.editing) {
        const px = latLngToPx(e.latlng);
        const id = 'X' + (TREASURES.length + 1);
        const posPct = [ Math.round((px.x/state.imageSize.w)*100), Math.round((px.y/state.imageSize.h)*100) ];
        let hint = prompt('Podaj nazwƒô/wskaz√≥wkƒô:');
        if (!hint) return;
        let code = prompt('Podaj 4-cyfrowe has≈Ço:');
        if (!/^\d{4}$/.test(code)) { toast('Has≈Ço musi mieƒá 4 cyfry'); return; }
        const newTreasure = { id, posPct, hint: hint.trim(), code: code };
        TREASURES.push(newTreasure);
        refreshMarkers();
      }
    });
    document.getElementById('hintBtn').addEventListener('click', () => {
      const remaining = TREASURES.filter(t => !state.found.has(t.id));
      if (!remaining.length) { toast('Wszystkie skarby znalezione!'); return; }
      const firstVisible = remaining.find(t => {
        const markerEl = markers.get(t.id)?.getElement()?.querySelector('.x-marker');
        return markerEl && !markerEl.classList.contains('hidden');
      });
      if (firstVisible) toast(`Wskaz√≥wka: ${firstVisible.hint}`);
    });
    document.getElementById('resetBtn').addEventListener('click', () => { state.found.clear(); refreshMarkers(); });
    document.getElementById('newGameBtn').addEventListener('click', () => { TREASURES = []; state.found.clear(); refreshMarkers(); state.editing = true; toast('Dodaj skarby na mapie'); });
    (async function init() {
      const img = new Image();
      img.onload = () => {
        state.imageSize = { w: img.naturalWidth, h: img.naturalHeight };
        const w = state.imageSize.w, h = state.imageSize.h;
        const southWest = map.unproject([0, h], getMaxZoomForImage());
        const northEast = map.unproject([w, 0], getMaxZoomForImage());
        const bounds = new L.LatLngBounds(southWest, northEast);
        L.imageOverlay(MAP_IMAGE_URL, bounds).addTo(map);
        map.fitBounds(bounds);
        map.setMaxBounds(bounds.pad(0.2));
        refreshMarkers();
      };
      img.src = MAP_IMAGE_URL;
    })();
  </script>
</body>
</html>
