<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Mapa Skarb√≥w</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root { --bg:#f7f7fb; --fg:#1f2937; --brand:#ff7a00; --accent:#00a884; --muted:#94a3b8; --card:#ffffff; --danger:#e11d48; --x-size:22px; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    #map{width:100%;height:100%}

    .controls{position:absolute;top:5.5rem;left:.75rem;z-index:900;display:grid;gap:.4rem}
    .btn{appearance:none;border:0;background:var(--card);color:#111;padding:.55rem 0.9rem;border-radius:.8rem;box-shadow:0 4px 16px rgba(0,0,0,.12);font-weight:700;font-size:.95rem}
    .btn.brand{background:var(--brand);color:#fff;border:3px solid #fff;box-shadow:0 4px 12px rgba(0,0,0,.4)}
    .btn.accent{background:var(--accent);color:#fff}

    .x-marker{background:transparent;display:grid;place-items:center}
    .x-marker> b{font-size:var(--x-size);color:var(--danger);-webkit-text-stroke:2px #fff;text-shadow:0 1px 0 #fff,0 0 6px rgba(0,0,0,.35);line-height:1}
    .x-marker.hidden{display:none}
    .x-marker.found{opacity:.35;filter:grayscale(1)}

    .status{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(env(safe-area-inset-bottom) + 4.6rem);z-index:1000;background:var(--card);padding:.7rem .95rem;border-radius:.9rem;box-shadow:0 6px 18px rgba(0,0,0,.15);min-width:260px;text-align:center}
    .status .counter{font-weight:800}
    .status .text{color:var(--muted);font-weight:700;margin-top:.25rem}

    .pinbar{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(env(safe-area-inset-bottom) + 1rem);z-index:1000}
    .toast{position:fixed;left:50%;bottom:9.8rem;transform:translateX(-50%);background:#111827;color:#fff;padding:.7rem .9rem;border-radius:.8rem;box-shadow:0 8px 20px rgba(0,0,0,.3);font-weight:700;opacity:0;pointer-events:none;transition:opacity .25s ease}
    .toast.show{opacity:1}

    /* Ekran wygranej */
    .win-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;flex-direction:column;z-index:1200;color:#fff;text-align:center}
    .win-overlay.show{display:flex;animation:fadeIn .4s ease}
    .win-title{font-size:2rem;font-weight:900;margin-bottom:.5rem}
    .win-sub{opacity:.9;font-weight:700;margin-bottom:1rem}
    .confetti{position:absolute;inset:0;overflow:hidden;pointer-events:none}
    .piece{position:absolute;top:-10vh;font-size:1.6rem;animation:fall 3.5s linear infinite;opacity:.9}
    @keyframes fall{0%{transform:translateY(-10vh) rotate(0)}100%{transform:translateY(110vh) rotate(720deg)}}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}

    /* üß∞ Tryb edycji: wy≈ÇƒÖcz klikalno≈õƒá marker√≥w i UKRYJ je wizualnie */
    body.editing .leaflet-marker-pane{ pointer-events:none; }
    body.editing .x-marker{ display:none !important; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="controls">
    <button class="btn brand" id="hintBtn">üó∫Ô∏è Podpowied≈∫</button>
    <button class="btn" id="resetBtn">üîÅ Reset</button>
    <button class="btn accent" id="newGameBtn">üéØ Nowa gra</button>
    <button class="btn" id="startBtn">‚ñ∂Ô∏è Start gry</button>
  </div>

  <div class="status">
    <div><span class="counter" id="statusCounter">0/0</span></div>
    <div class="text" id="statusText">Kliknij ‚ÄûNowa gra‚Äù, aby dodaƒá skarby.</div>
  </div>

  <div class="pinbar">
    <button class="btn" id="enterPinBtn" style="padding:1rem 1.25rem;font-size:1rem;border:3px solid #fff;box-shadow:0 6px 18px rgba(0,0,0,.35);">üî¢ Wpisz has≈Ço</button>
  </div>

  <div class="toast" id="toast">Znaleziono skarb! üèÜ</div>

  <!-- Ekran wygranej -->
  <div class="win-overlay" id="winOverlay" role="dialog" aria-live="assertive">
    <div class="confetti" id="confetti"></div>
    <div class="win-title">üéâ Wygrana! üéâ</div>
    <div class="win-sub">Znale≈∫li≈õcie wszystkie skarby!</div>
    <button class="btn" id="closeWin">OK</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const MAP_IMAGE_URL='nowyplan.jpg';

    // Skarby: {id,posPct:[x%,y%],hint,code}
    let TREASURES=[];
    const state={imageSize:null,editing:false,found:new Set()};

    const toast=(m)=>{const el=document.getElementById('toast');el.textContent=m;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),1400);};
    const setStatus=(text)=>{ if(text!==undefined) document.getElementById('statusText').textContent=text; };
    const updateCounter=()=>{ const total=TREASURES.length; const found=[...state.found].filter(id=>TREASURES.some(t=>t.id===id)).length; document.getElementById('statusCounter').textContent=`${found}/${total}`; };
    const updateStatus=(text)=>{ updateCounter(); setStatus(text); };

    const map=L.map('map',{crs:L.CRS.Simple,zoomControl:false,minZoom:-2,maxZoom:2});
    let markers=new Map();

    function setEditing(on){ state.editing=on; document.body.classList.toggle('editing', !!on); }

    function getMaxZoomForImage(){return 2;}
    function pxToLatLng(x,y){return map.unproject([x,y],getMaxZoomForImage());}
    function latLngToPx(latlng){return map.project(latlng,getMaxZoomForImage());}
    function pctToPx([xp,yp]){const w=state.imageSize.w,h=state.imageSize.h;return [xp/100*w,yp/100*h];}

    function addMarker(t,visible){
      // Podczas edycji ukrywamy wszystkie markery (nawet je≈õli "visible" = true)
      const reallyVisible = !state.editing && !!visible;
      const iconHtml=`<div class="x-marker ${reallyVisible?'':'hidden'} ${state.found.has(t.id)?'found':''}"><b>‚úñ</b></div>`;
      const icon=L.divIcon({html:iconHtml,className:'',iconSize:[36,36],iconAnchor:[18,18]});
      const [x,y]=pctToPx(t.posPct); const ll=pxToLatLng(x,y);
      const m=L.marker(ll,{icon}).addTo(map);
      // Klik w X dzia≈Ça tylko poza trybem edycji
      m.on('click',()=>{ if(state.editing) return; trySolveById(t.id); });
      markers.set(t.id,m);
    }

    function refreshMarkers(){
      markers.forEach(m=>map.removeLayer(m)); markers.clear();
      TREASURES.forEach((t,i)=>addMarker(t,i===0));
      updateCounter();
    }

    function applyEditingVisibility(){
      // Ukryj lub poka≈º markery zale≈ºnie od trybu
      TREASURES.forEach((t,i)=>{
        const el=markers.get(t.id)?.getElement()?.querySelector('.x-marker');
        if(!el) return;
        if(state.editing){
          el.classList.add('hidden');
        }else{
          // poza edycjƒÖ pokazuj tylko pierwszy niezdobyty X
          if(i===0) el.classList.remove('hidden'); else el.classList.add('hidden');
        }
      });
    }

    function showOnlyFirst(){
      TREASURES.forEach((t,i)=>{
        const el=markers.get(t.id)?.getElement()?.querySelector('.x-marker');
        if(!el) return; if(i===0) el.classList.remove('hidden'); else el.classList.add('hidden');
      });
      updateCounter();
    }

    function currentVisibleIndex(){
      for(let i=0;i<TREASURES.length;i++){
        const id=TREASURES[i].id;
        if(state.found.has(id)) continue;
        const el=markers.get(id)?.getElement()?.querySelector('.x-marker');
        if(el && !el.classList.contains('hidden')) return i;
      }
      return -1;
    }

    function revealNextById(id){
      const idx=TREASURES.findIndex(x=>x.id===id);
      if(idx+1<TREASURES.length){
        const nm=markers.get(TREASURES[idx+1].id);
        nm?.getElement()?.querySelector('.x-marker')?.classList.remove('hidden');
        updateStatus('Brawo! Teraz wpisz has≈Ço do nastƒôpnego X.');
      } else {
        celebrateWin();
      }
    }

    function celebrateWin(){
      updateStatus('üéâ Wygrana! Wszystkie skarby zdobyte.');
      const overlay=document.getElementById('winOverlay');
      overlay.classList.add('show');
      spawnConfetti();
      playWinSound();
    }

    function spawnConfetti(){
      const c = document.getElementById('confetti');
      c.innerHTML='';
      const symbols = ['üéà','üéâ','‚ú®','‚≠ê','üéä','üíé'];
      for(let i=0;i<36;i++){
        const el=document.createElement('div');
        el.className='piece';
        el.textContent=symbols[i % symbols.length];
        el.style.left=Math.random()*100+'%';
        el.style.animationDelay=(Math.random()*1.5)+'s';
        el.style.animationDuration=(3+Math.random()*2)+'s';
        c.appendChild(el);
      }
      document.getElementById('closeWin').onclick=()=>{
        c.innerHTML='';
        document.getElementById('winOverlay').classList.remove('show');
      };
    }

    function playWinSound(){
      try{
        const ctx=new (window.AudioContext||window.webkitAudioContext)();
        const notes=[880,988,1046]; // A5, B5, C6
        let t=ctx.currentTime;
        notes.forEach((f,i)=>{
          const o=ctx.createOscillator();
          const g=ctx.createGain();
          o.type='sine'; o.frequency.value=f;
          o.connect(g); g.connect(ctx.destination);
          const dur=0.22;
          g.gain.setValueAtTime(0,t);
          g.gain.linearRampToValueAtTime(0.4,t+0.02);
          g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
          o.start(t); o.stop(t+dur);
          t+=dur+0.05;
        });
      }catch(e){ /* brak wsparcia audio - ignoruj */ }
    }

    function trySolveById(id){
      const t=TREASURES.find(x=>x.id===id); if(!t) return;
      const el=markers.get(id)?.getElement()?.querySelector('.x-marker');
      if(!el || el.classList.contains('hidden')){ toast('Najpierw odblokuj poprzedni skarb lub wci≈õnij ‚ñ∂Ô∏è Start gry.'); return; }
      const v=prompt(`Wpisz 4-cyfrowe has≈Ço:\n${t.hint||t.id}`);
      if(v===null) return; const s=String(v).trim();
      if(!/^\d{4}$/.test(s)){ toast('Has≈Ço musi mieƒá dok≈Çadnie 4 cyfry.'); return; }
      if(s===t.code){ state.found.add(id); el.classList.add('found'); updateStatus('Skarb zdobyty! üèÜ'); revealNextById(id); } else { toast('B≈Çƒôdne has≈Ço ‚ùå'); }
    }

    // Dodawanie X-√≥w z walidacjƒÖ PIN (4 cyfry) ‚Äî brak limitu odleg≈Ço≈õci, markery ukryte w edycji
    map.on('click',e=>{
      if(!state.editing || !state.imageSize) return;
      const px=latLngToPx(e.latlng);
      const id='X'+(TREASURES.length+1);
      const posPct=[ Math.round((px.x/state.imageSize.w)*100), Math.round((px.y/state.imageSize.h)*100) ];
      let hint=prompt('Nazwa (wskaz√≥wka) dla skarbu:');
      if(hint===null) return; hint=hint.trim(); if(!hint){ toast('Wpisz nazwƒô/wskaz√≥wkƒô.'); return; }
      let code=null; while(true){ const inp=prompt('Ustal 4-cyfrowe has≈Ço dla skarbu:'); if(inp===null){ code=null; break; } const s=String(inp).trim(); if(/^\d{4}$/.test(s)){ code=s; break; } toast('Has≈Ço musi mieƒá dok≈Çadnie 4 cyfry.'); }
      if(code===null) return;
      const t={id,posPct,hint,code}; TREASURES.push(t); addMarker(t, /*visible=*/false); updateCounter();
      const more=confirm('Dodaƒá kolejny X?'); if(!more){ setEditing(false); updateStatus('Gotowe. Naci≈õnij ‚ñ∂Ô∏è Start gry.'); }
    });

    // Przyciski
    document.getElementById('hintBtn').addEventListener('click',()=>{
      const i=currentVisibleIndex();
      if(i===-1){ toast(TREASURES.length?'Odblokuj poprzedni skarb.':'Brak punkt√≥w ‚Äî u≈ºyj ‚ÄûüéØ Nowa gra‚Äù.'); return; }
      updateStatus('Wskaz√≥wka: '+(TREASURES[i].hint||'Rozejrzyj siƒô uwa≈ºnie...'));
    });

    document.getElementById('enterPinBtn').addEventListener('click',()=>{
      const i=currentVisibleIndex();
      if(i===-1){ toast(TREASURES.length?'Najpierw odblokuj poprzedni skarb.':'Brak punkt√≥w ‚Äî u≈ºyj ‚ÄûüéØ Nowa gra‚Äù.'); return; }
      trySolveById(TREASURES[i].id);
      updateCounter();
    });

    document.getElementById('resetBtn').addEventListener('click',()=>{
      state.found.clear();
      showOnlyFirst();
      updateStatus('Postƒôp zresetowany. Wci≈õnij ‚ñ∂Ô∏è Start gry.');
    });

    document.getElementById('newGameBtn').addEventListener('click',()=>{
      if(!confirm('Czy na pewno chcesz rozpoczƒÖƒá nowƒÖ grƒô? Wszystkie skarby i postƒôp zostanƒÖ utracone.')) return;
      TREASURES=[]; state.found.clear(); refreshMarkers(); setEditing(true);
      updateStatus('Instrukcja: stuknij w mapƒô, aby dodaƒá X (nazwa + PIN 4 cyfry). Dodaj minimum jeden X, potem ‚Äû‚ñ∂Ô∏è Start gry‚Äù.');
      applyEditingVisibility();
    });

    document.getElementById('startBtn').addEventListener('click',()=>{
      if(TREASURES.length===0){ toast('Najpierw dodaj przynajmniej jeden X.'); return; }
      setEditing(false);
      showOnlyFirst();
      const i=currentVisibleIndex();
      const msg=i>-1?`Start! Wpisz has≈Ço do pierwszego X. Wskaz√≥wka: ${TREASURES[i].hint}`:'Start!';
      updateStatus(msg);
    });

    // Init
    (function init(){
      const img=new Image();
      img.onload=()=>{
        state.imageSize={w:img.naturalWidth,h:img.naturalHeight};
        const w=state.imageSize.w,h=state.imageSize.h;
        const sw=map.unproject([0,h],getMaxZoomForImage());
        const ne=map.unproject([w,0],getMaxZoomForImage());
        const bounds=new L.LatLngBounds(sw,ne);
        L.imageOverlay(MAP_IMAGE_URL,bounds).addTo(map);
        map.fitBounds(bounds); map.setMaxBounds(bounds.pad(0.2));
        updateStatus('Kliknij ‚ÄûNowa gra‚Äù, aby dodaƒá skarby.');
      };
      img.src=MAP_IMAGE_URL;
    })();
  </script>
</body>
</html>
