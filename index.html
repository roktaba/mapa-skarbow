<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Mapa Skarb√≥w</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root { --bg:#f7f7fb; --fg:#1f2937; --brand:#ff7a00; --accent:#00a884; --muted:#94a3b8; --card:#ffffff; --danger:#e11d48; --x-size:22px; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    #map{width:100%;height:100%}
    .controls{position:absolute;top:3.5rem;left:.75rem;z-index:900;display:grid;gap:.4rem}
    .btn{appearance:none;border:0;background:var(--card);color:#111;padding:.55rem .7rem;border-radius:.8rem;box-shadow:0 4px 16px rgba(0,0,0,.12);font-weight:700;font-size:.9rem}
    .btn.brand{background:var(--brand);color:#fff;border:3px solid #fff;box-shadow:0 4px 12px rgba(0,0,0,.4)}
    .btn.accent{background:var(--accent);color:#fff}
    .x-marker{background:transparent;display:grid;place-items:center}
    .x-marker> b{font-size:var(--x-size);color:var(--danger);-webkit-text-stroke:2px #fff;text-shadow:0 1px 0 #fff,0 0 6px rgba(0,0,0,.35);line-height:1}
    .x-marker.hidden{display:none}
    .x-marker.found{opacity:.35;filter:grayscale(1)}
    .toast{position:fixed;left:50%;bottom:6rem;transform:translateX(-50%);background:#111827;color:#fff;padding:.7rem .9rem;border-radius:.8rem;box-shadow:0 8px 20px rgba(0,0,0,.3);font-weight:700;opacity:0;pointer-events:none;transition:opacity .25s ease}
    .toast.show{opacity:1}
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="controls">
    <button class="btn brand" id="hintBtn">üó∫Ô∏è Podpowied≈∫</button>
    <button class="btn" id="resetBtn">üîÅ Reset</button>
    <button class="btn accent" id="newGameBtn">üéØ Nowa gra</button>
    <button class="btn" id="startBtn">‚ñ∂Ô∏è Start gry</button>
  </div>
  <div class="toast" id="toast">Znaleziono skarb! üèÜ</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const MAP_IMAGE_URL='nowyplan.jpg';
    const CATCH_RADIUS_PCT=3.5;

    // Skarby: {id,posPct:[x%,y%],hint,code}
    let TREASURES=[];
    const state={imageSize:null,editing:false,found:new Set()};

    const toast=(m)=>{const el=document.getElementById('toast');el.textContent=m;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),1400);};

    const map=L.map('map',{crs:L.CRS.Simple,zoomControl:false,minZoom:-2,maxZoom:2});
    let markers=new Map();

    function getMaxZoomForImage(){return 2;}
    function pxToLatLng(x,y){return map.unproject([x,y],getMaxZoomForImage());}
    function latLngToPx(latlng){return map.project(latlng,getMaxZoomForImage());}
    function pctToPx([xp,yp]){const w=state.imageSize.w,h=state.imageSize.h;return [xp/100*w,yp/100*h];}
    function catchRadiusPx(){const m=Math.min(state.imageSize.w,state.imageSize.h);return (CATCH_RADIUS_PCT/100)*m;}

    function addMarker(t, visible){
      const iconHtml=`<div class="x-marker ${visible?'':'hidden'} ${state.found.has(t.id)?'found':''}"><b>‚úñ</b></div>`;
      const icon=L.divIcon({html:iconHtml,className:'',iconSize:[36,36],iconAnchor:[18,18]});
      const [x,y]=pctToPx(t.posPct);
      const ll=pxToLatLng(x,y);
      const m=L.marker(ll,{icon}).addTo(map);

      m.on('click',()=>{
        const el=m.getElement()?.querySelector('.x-marker');
        const isVisible=el && !el.classList.contains('hidden');
        if(state.editing || !isVisible) return;

        // Trafienie blisko ≈õrodka X
        const centerPx=latLngToPx(m.getLatLng());
        const dist=Math.hypot(centerPx.x-lastTapPx.x,centerPx.y-lastTapPx.y);
        if(dist>catchRadiusPx()){ toast('Podejd≈∫ bli≈ºej miejsca X üë£'); return; }

        // PIN 4 cyfry
        const v=prompt(`Wpisz 4-cyfrowe has≈Ço:\n${t.hint||t.id}`);
        if(v===null) return;
        if(!/^\d{4}$/.test(String(v).trim())){ toast('Has≈Ço musi mieƒá dok≈Çadnie 4 cyfry.'); return; }
        if(String(v).trim()===t.code){
          state.found.add(t.id);
          el.classList.add('found');
          toast('Znaleziono skarb! üèÜ');
          revealNextById(t.id);
        } else {
          toast('B≈Çƒôdne has≈Ço ‚ùå');
        }
      });

      markers.set(t.id,m);
    }

    function revealNextById(id){
      const idx=TREASURES.findIndex(x=>x.id===id);
      if(idx+1<TREASURES.length){
        const nm=markers.get(TREASURES[idx+1].id);
        const nel=nm?.getElement()?.querySelector('.x-marker');
        if(nel) nel.classList.remove('hidden');
      } else {
        toast('Wszystkie skarby zdobyte! üéâ');
      }
    }

    function refreshMarkers(){
      markers.forEach(m=>map.removeLayer(m));
      markers.clear();
      TREASURES.forEach((t,i)=>addMarker(t,i===0)); // tylko pierwszy widoczny
    }

    function showOnlyFirst(){
      TREASURES.forEach((t,i)=>{
        const m=markers.get(t.id);
        const el=m?.getElement()?.querySelector('.x-marker');
        if(!el) return;
        if(i===0) el.classList.remove('hidden'); else el.classList.add('hidden');
      });
    }

    let lastTapPx={x:0,y:0};
    map.on('click',e=>{
      lastTapPx=latLngToPx(e.latlng);
      if(!state.editing || !state.imageSize) return;

      const id='X'+(TREASURES.length+1);
      const posPct=[ Math.round((lastTapPx.x/state.imageSize.w)*100), Math.round((lastTapPx.y/state.imageSize.h)*100) ];

      let hint=prompt('Nazwa (wskaz√≥wka) dla skarbu:');
      if(hint===null) return;
      hint=hint.trim();
      if(!hint){ toast('Wpisz nazwƒô/wskaz√≥wkƒô.'); return; }

      // Walidacja PIN: wymu≈õ 4 cyfry (pƒôtla)
      let code=null;
      while(true){
        const input=prompt('Ustal 4-cyfrowe has≈Ço dla skarbu:');
        if(input===null){ code=null; break; }
        const trimmed=String(input).trim();
        if(/^\d{4}$/.test(trimmed)){ code=trimmed; break; }
        toast('Has≈Ço musi mieƒá dok≈Çadnie 4 cyfry.');
      }
      if(code===null) return;

      const t={id,posPct,hint,code};
      TREASURES.push(t);
      addMarker(t, TREASURES.length===1);

      const more=confirm('Dodaƒá kolejny X?');
      if(!more){ state.editing=false; toast('Gotowe. Naci≈õnij ‚ñ∂Ô∏è Start gry.'); }
    });

    // UI
    document.getElementById('hintBtn').addEventListener('click',()=>{
      // Wskaz√≥wka do pierwszego widocznego i niezdobytego X
      for(let i=0;i<TREASURES.length;i++){
        const id=TREASURES[i].id;
        if(state.found.has(id)) continue;
        const el=markers.get(id)?.getElement()?.querySelector('.x-marker');
        if(el && !el.classList.contains('hidden')){ toast('Wskaz√≥wka: '+(TREASURES[i].hint||'Rozejrzyj siƒô uwa≈ºnie...')); return; }
      }
      toast(TREASURES.length?'Wszystko zdobyte! üéâ':'Brak punkt√≥w ‚Äî u≈ºyj ‚ÄûüéØ Nowa gra‚Äù.');
    });

    document.getElementById('resetBtn').addEventListener('click',()=>{
      state.found.clear();
      showOnlyFirst();
      toast('Postƒôp zresetowany');
    });

    document.getElementById('newGameBtn').addEventListener('click',()=>{
      if(!confirm('RozpoczƒÖƒá nowƒÖ grƒô? Obecne punkty zostanƒÖ usuniƒôte.')) return;
      TREASURES=[];
      state.found.clear();
      refreshMarkers();
      state.editing=true;
      toast('Dodaj co najmniej jeden X. Stuknij w mapƒô.');
    });

    document.getElementById('startBtn').addEventListener('click',()=>{
      if(TREASURES.length===0){ toast('Najpierw dodaj przynajmniej jeden X.'); return; }
      state.editing=false;
      showOnlyFirst();
      toast('Start! Szukaj pierwszego X.');
    });

    // Init
    (function init(){
      const img=new Image();
      img.onload=()=>{
        state.imageSize={w:img.naturalWidth,h:img.naturalHeight};
        const w=state.imageSize.w,h=state.imageSize.h;
        const sw=map.unproject([0,h],getMaxZoomForImage());
        const ne=map.unproject([w,0],getMaxZoomForImage());
        const bounds=new L.LatLngBounds(sw,ne);
        L.imageOverlay(MAP_IMAGE_URL,bounds).addTo(map);
        map.fitBounds(bounds);
        map.setMaxBounds(bounds.pad(0.2));
      };
      img.src=MAP_IMAGE_URL;
    })();
  </script>
</body>
</html>
